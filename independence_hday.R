##----------------------------------------------------------------------------------------------------------##
##Calculate violations.
##----------------------------------------------------------------------------------------------------------##
violations_hday <- function(data_1, VaR)
{
  sp_ten_day <- rollapply(data_1, 10, sum)
  violations <- sp_ten_day[1001:length(sp_ten_day)] > VaR
  return(violations)
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##





##----------------------------------------------------------------------------------------------------------##
##Calculate independence.
##----------------------------------------------------------------------------------------------------------##
ind_hday <- function(violations, h)
{
  v1 <- coredata(as.array(violations[1:n-h]))
  v2 <- coredata(as.array(violations[1+h:n]))
  
  T11 <- sum(v1 & v2)
  T00 <- sum(!v1 & !v2)
  T10 <- sum(v1 > v2)
  T01 <- sum(v2 < v1)
  
  pi11 <- T11/(T11+T10)
  pi10 <- T10/(T11+T10)
  pi01 <- T01/(T00+T01)
  pi00 <- T00/(T00+T01)
  pi2 = (T01+T11)/(T00+T01+T10+T11)
  
  H0 <- (T00+T10)*log(1-pi2) + (T11+T01)*log(pi2)
  HA <- T00*log(pi00) + T01*log(pi01) + T10*log(pi10) + T11*log(pi11)
  LR_ind <- -2*(H0-HA)
  p_value <- 1 - pchisq(q = LR_ind, df = 1)
  
  return(list(pi11 = pi11, pi10 = pi10, pi01 = pi01, pi00 = pi00, pi2 = pi2, LR = LR_ind, p = p_value))
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##





##----------------------------------------------------------------------------------------------------------##
##Main function to perform backtesting on h-day ahead VaR.
##----------------------------------------------------------------------------------------------------------##
backtesting_hday <- function(data_1, VaR, h)
{
  violations_vec <- violations_hday(data_1, VaR)
  hday_independence <- ind_hday(violations_vec, h)
  return(hday_independence)
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##