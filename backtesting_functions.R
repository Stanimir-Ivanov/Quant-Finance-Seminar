##----------------------------------------------------------------------------------------------------------##
##Count violations of VaR and find transition matrix.
##----------------------------------------------------------------------------------------------------------##
counting_violations <- function(VaR, data_1, h)
{
  #Calculate violations vector
  violations <- data_1 > VaR
  violations <- violations[!is.na(violations)]
  n <- length(violations)
  n_violations <- sum(violations)
  
  v1 <- coredata(as.array(violations[1:(n-h)]))
  v2 <- coredata(as.array(violations[(1+h):n]))
  
  T11 <- sum(v1 & v2)
  T00 <- sum(!v1 & !v2)
  T10 <- sum(v1 > v2)
  T01 <- sum(v2 < v1)
  
  return(list(v = n_violations, vec = violations))
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##





##----------------------------------------------------------------------------------------------------------##
##Calculate unconditional coverage.
##----------------------------------------------------------------------------------------------------------##
unconditional_coverage <- function(n_violations, length_data, q)
{
  T1 <- n_violations
  T0 <- length_data - n_violations
  pi_hat <- T1/length_data
  
  H0 <- T0*log(1-q) + T1*log(q)
  HA <- T0*log(1-pi_hat) + T1*log(pi_hat)
  LR_uc <- -2*(H0 - HA)
  p_value <- 1 - pchisq(q = LR_uc, df = 1)
  
  return(list(LR = LR_uc, p = p_value))
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##





##----------------------------------------------------------------------------------------------------------##
##Calculate independence.
##----------------------------------------------------------------------------------------------------------##
ind_hday <- function(violations, h)
{
  v1 <- coredata(as.array(violations[1:(length(violations)-h)]))
  v2 <- coredata(as.array(violations[(1+h):length(violations)]))
  
  T11 <- sum(v1 & v2)
  T00 <- sum(!v1 & !v2)
  T10 <- sum(v1 > v2)
  T01 <- sum(v2 < v1)
  
  pi11 <- T11/(T11+T10)
  pi10 <- T10/(T11+T10)
  pi01 <- T01/(T00+T01)
  pi00 <- T00/(T00+T01)
  pi2 = (T01+T11)/(T00+T01+T10+T11)
  
  H0 <- (T00+T10)*log(1-pi2) + (T11+T01)*log(pi2)
  HA <- T00*log(pi00) + T01*log(pi01) + T10*log(pi10) + T11*log(pi11)
  LR_ind <- -2*(H0-HA)
  p_value <- 1 - pchisq(q = LR_ind, df = 1)
  
  return(list(LR = LR_ind, p = p_value))
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##





##----------------------------------------------------------------------------------------------------------##
##Calculate conditional coverage.
##----------------------------------------------------------------------------------------------------------##
conditional_coverage <- function(LR_uc, LR_ind)
{
  LR_cc <- LR_uc + LR_ind
  p_value <- 1 - pchisq(q = LR_cc, df = 2)
  
  return(list(LR = LR_cc, p = p_value))
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##





##----------------------------------------------------------------------------------------------------------##
##VaR backtesting main function.
##----------------------------------------------------------------------------------------------------------##
backtesting_function <- function(VaR, data_1, h, q)
{
  violations_info <- counting_violations(VaR, data_1, h)

  ind <- ind_hday(violations_info$vec, h)
  unc_cov <- unconditional_coverage(violations_info$v, length(data_1), q)
  cc <- conditional_coverage(unc_cov$LR, ind$LR)

  
  return(list(v = violations_info$v, uc = unc_cov$p, ind = ind$p, cc = cc$p))
}
##----------------------------------------------------------------------------------------------------------##
##----------------------------------------------------------------------------------------------------------##